<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://telegram.org/js/telegram-web-app.js?2"></script>
  <title>Книги</title>

  <style>
    body {
      font-family: sans-serif;
      background-color: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #222);
      font-size: 14px;
      margin: 0;
      padding: 10px;
    }

    .book-card {
      display: flex;
      align-items: center;
      background-color: var(--tg-theme-secondary-bg-color, #f9f9f9);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 14px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .book-card img {
      width: 90px;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      margin-right: 14px;
      flex-shrink: 0;
      background-color: #eee;
    }

    .book-info {
      display: flex;
      flex-direction: column;
      justify-content: center;
      flex-grow: 1;
    }

    .book-title {
      font-size: 16px;
      margin-bottom: 10px;
      line-height: 1.4;
      font-weight: 500;
    }

    .counter {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 14px;
      padding-right: 6px;
      margin-top: 6px;
    }

    .counter button {
      width: 44px;
      height: 44px;
      font-size: 26px;
      border: none;
      border-radius: 12px;
      background-color: var(--tg-theme-button-color, #50a8eb);
      color: var(--tg-theme-button-text-color, #fff);
      cursor: pointer;
    }

    .counter span {
      font-size: 20px;
      min-width: 28px;
      text-align: center;
      font-weight: bold;
    }

    @media (max-width: 380px) {
      .book-card {
        padding: 8px;
        margin-bottom: 10px;
      }

      .book-card img {
        width: 70px;
        height: 95px;
        margin-right: 10px;
      }

      .book-title {
        font-size: 15px;
        margin-bottom: 6px;
      }

      .counter {
        gap: 10px;
        padding-right: 4px;
      }

      .counter button {
        width: 38px;
        height: 38px;
        font-size: 22px;
        border-radius: 10px;
      }

      .counter span {
        font-size: 18px;
      }
    }
  </style>
</head>

<body style="visibility:hidden;">

  <section id="top_sect"></section>

  <script>
    const DemoApp = {
      initData: Telegram.WebApp.initData || '',
      initDataUnsafe: Telegram.WebApp.initDataUnsafe || {},
      MainButton: Telegram.WebApp.MainButton,
      maxBooks: 4,
      selectedCount: 0,

      init() {
        document.body.style.visibility = '';
        Telegram.WebApp.ready();
        Telegram.WebApp.disableVerticalSwipes();
        Telegram.WebApp.expand();
        Telegram.WebApp.MainButton.setParams({
          text: 'Отправить',
          is_visible: true
        }).onClick(DemoApp.sendData);
      },

      sendData() {
        const quantities = document.querySelectorAll('.quantity');
        let message = '';
        let hasSelection = false;

        quantities.forEach(span => {
          const count = parseInt(span.getAttribute('data-count'));
          if (count > 0) {
            const bookName = span.closest('.book-info').querySelector('.book-title').textContent;
            message += `${bookName} /${count}шт.\n`;
            hasSelection = true;
          }
        });

        if (!hasSelection) {
          Telegram.WebApp.showAlert('Ничего не выбрано');
          return;
        }

        Telegram.WebApp.sendData(message.trim());
        Telegram.WebApp.close();
      },

      loadData() {
        fetch('https://script.google.com/macros/s/AKfycbx_s1nmi49LwwwzJDPY_doB7KkSzyndcXXPv-WTUHshjk_susjG0vaIJGaVz8TElljinw/exec')
          .then(response => response.json())
          .then(data => {
            const books = data.books.map(book => ({
              ...book,
              image: book.image || 'https://cdn.eksmo.ru/v2/ITD000000001445058/COVER/'
            }));
            DemoApp.renderBooks(books);
          })
          .catch(error => {
            console.error('Ошибка при загрузке данных:', error);
            Telegram.WebApp.MainButton.hideProgress();
          });
      },

      renderBooks(books) {
        const section = document.getElementById('top_sect');
        section.innerHTML = '';

        books.forEach(book => {
          const card = document.createElement('div');
          card.className = 'book-card';
          card.innerHTML = `
            <img src="${book.image}" alt="${book.name}">
            <div class="book-info">
              <div class="book-title">${book.name}</div>
              <div class="counter">
                <button class="decrease" data-id="${book.id}">−</button>
                <span id="quantity-${book.id}" class="quantity" data-count="0">0</span>
                <button class="increase" data-id="${book.id}">+</button>
              </div>
            </div>
          `;
          section.appendChild(card);
        });

        document.querySelectorAll('.increase').forEach(btn => {
          btn.addEventListener('click', e => {
            const id = e.target.getAttribute('data-id');
            const span = document.getElementById(`quantity-${id}`);
            let count = parseInt(span.getAttribute('data-count'));

            if (DemoApp.selectedCount >= DemoApp.maxBooks) {
              Telegram.WebApp.showAlert(`Вы не можете выбрать более ${DemoApp.maxBooks} книг.`);
              return;
            }

            Telegram.WebApp.HapticFeedback.impactOccurred('light');
            span.setAttribute('data-count', count + 1);
            span.textContent = count + 1;
            DemoApp.selectedCount++;
          });
        });

        document.querySelectorAll('.decrease').forEach(btn => {
          btn.addEventListener('click', e => {
            const id = e.target.getAttribute('data-id');
            const span = document.getElementById(`quantity-${id}`);
            let count = parseInt(span.getAttribute('data-count'));

            Telegram.WebApp.HapticFeedback.impactOccurred('light');
            if (count > 0) {
              span.setAttribute('data-count', count - 1);
              span.textContent = count - 1;
              DemoApp.selectedCount--;
            }
          });
        });

        Telegram.WebApp.MainButton.hideProgress();
      }
    };

    DemoApp.init();
    Telegram.WebApp.setHeaderColor('secondary_bg_color');
    DemoApp.loadData();
  </script>
</body>

</html>
